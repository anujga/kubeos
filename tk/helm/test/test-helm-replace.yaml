apiVersion: tekton.dev/v1beta1
kind: Pipeline
metadata:
  name: test-helm-replace
spec:
  params:
  - name: repo-url
    type: string
    description: The git repository URL to clone from.
  - name: tagValue
    type: string
    default: "9999.9999.9999"
  - name: repoValue
    type: string
    default: "dockerhub.com/foobar"
  workspaces:
  - name: shared-data

  tasks:
  - name: fetch-repo
    taskRef:
      name: git-clone
    workspaces:
    - name: output
      workspace: shared-data
    params:
    - name: url
      value: $(params.repo-url)
    - name: revision
      value: master

  - name: helm-replace
    runAfter:
    - fetch-repo
    workspaces:
    - name: source
      workspace: shared-data
    taskRef:
      name: helm-replace
    params:
    - name: chartName
      value: hello-go
    - name: tagValue
      value: $(params.tagValue)
    - name: repoValue
      value: $(params.repoValue)

  - name: check-file
    runAfter:
    - helm-replace
    workspaces:
    - name: source
      workspace: shared-data
    params:
    - name: fileName
      value: "charts/hello-go/values.yaml"
    - name: tagValue
      value: $(params.tagValue)
    taskSpec:
      workspaces:
      - name: source
      params:
      - name: fileName
        type: string
      - name: tagValue
        type: string
      steps:
      - image: anujgarg2004/buildhelpers:0.0.2
        script: |
          #!/usr/bin/env bash
          set -ex
          f="$(workspaces.source.path)/$(params.fileName)"
          cat ${f}
          base=$(yq r ${f} "image.tag")
          echo $base
          if [ "$base" != "$(params.tagValue)" ]
          then
            exit -1
          fi
---
apiVersion: tekton.dev/v1beta1
kind: PipelineRun
metadata:
  name: test-helm-replace-01
spec:
  pipelineRef:
    name: test-helm-replace
  serviceAccountName: meson-bot
  workspaces:
  - name: shared-data
    volumeClaimTemplate:
      spec:
        accessModes:
        - ReadWriteOnce
        resources:
          requests:
            storage: 1Gi
  params:
  - name: repo-url
    value: git@github.com:anujga/hello-go.git
